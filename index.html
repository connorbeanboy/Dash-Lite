<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

/* ================= STATE ================= */
let state = "menu"; // menu, play, editor
let gameMode = "cube";
let holding = false;

/* ================= PLAYER ================= */
const player = {
    x: 120,
    y: 300,
    size: 32,
    vy: 0,
    waveDir: -1
};

const gravity = 0.7;
const speed = 5;

/* ================= LEVEL ================= */
let objects = [];
let selected = "spike";

/* ================= INPUT ================= */
document.addEventListener("keydown", e => {
    if (e.code === "Space") holding = true;

    if (state === "menu") {
        if (e.key === "p") startPlay();
        if (e.key === "e") state = "editor";
    }

    if (state === "editor") {
        if (e.key === "1") selected = "spike";
        if (e.key === "2") selected = "block";
        if (e.key === "3") selected = "cube";
        if (e.key === "4") selected = "ship";
        if (e.key === "5") selected = "ufo";
        if (e.key === "6") selected = "wave";
        if (e.key === "s") saveLevel();
        if (e.key === "l") loadLevel();
        if (e.key === "p") startPlay();
    }

    if (e.key === "Escape") state = "menu";
});

document.addEventListener("keyup", e => {
    if (e.code === "Space") holding = false;
});

canvas.addEventListener("mousedown", e => {
    if (state !== "editor") return;
    const r = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - r.left) / 40) * 40;
    const y = Math.floor((e.clientY - r.top) / 40) * 40;
    objects.push({ type: selected, x, y });
});

/* ================= SAVE ================= */
function saveLevel() {
    localStorage.setItem("dashLite", JSON.stringify(objects));
}
function loadLevel() {
    const data = localStorage.getItem("dashLite");
    if (data) objects = JSON.parse(data);
}

/* ================= PLAY ================= */
function startPlay() {
    state = "play";
    player.y = 300;
    player.vy = 0;
    gameMode = "cube";
}

/* ================= COLLISION ================= */
function hit(o) {
    return (
        player.x < o.x + 40 &&
        player.x + player.size > o.x &&
        player.y < o.y + 40 &&
        player.y + player.size > o.y
    );
}

/* ================= UPDATE ================= */
function update() {
    if (state !== "play") return;

    if (gameMode === "cube") {
        player.vy += gravity;
        if (holding && player.y >= 300) player.vy = -12;
    }

    if (gameMode === "ship") {
        player.vy += holding ? -0.8 : 0.8;
        player.vy = Math.max(-7, Math.min(7, player.vy));
    }

    if (gameMode === "ufo") {
        player.vy += gravity * 0.8;
        if (holding) {
            player.vy = -10;
            holding = false;
        }
    }

    if (gameMode === "wave") {
        player.y += holding ? -8 : 8;
    }

    player.y += player.vy;

    if (player.y < 0 || player.y + player.size > canvas.height) die();

    objects.forEach(o => {
        o.x -= speed;

        if ((o.type === "spike" || o.type === "block") && hit(o)) die();
        if (["cube","ship","ufo","wave"].includes(o.type) && hit(o)) {
            gameMode = o.type;
        }
    });
}

/* ================= DIE ================= */
function die() {
    startPlay();
}

/* ================= DRAW ================= */
function draw() {
    ctx.fillStyle = "#f0f0f0";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (state === "menu") {
        ctx.fillStyle = "#000";
        ctx.font = "40px Arial";
        ctx.fillText("DASH LITE", 270, 160);
        ctx.font = "20px Arial";
        ctx.fillText("P = Play", 350, 210);
        ctx.fillText("E = Editor", 340, 240);
        return;
    }

    // Player
    ctx.fillStyle =
        gameMode === "cube" ? "red" :
        gameMode === "ship" ? "green" :
        gameMode === "ufo" ? "blue" :
        "purple";
    ctx.fillRect(player.x, player.y, player.size, player.size);

    // Objects
    objects.forEach(o => {
        if (o.type === "spike") {
            ctx.fillStyle = "#000";
            ctx.beginPath();
            ctx.moveTo(o.x, o.y + 40);
            ctx.lineTo(o.x + 20, o.y);
            ctx.lineTo(o.x + 40, o.y + 40);
            ctx.fill();
        } else if (o.type === "block") {
            ctx.fillStyle = "#444";
            ctx.fillRect(o.x, o.y, 40, 40);
        } else {
            ctx.fillStyle = "#00f";
            ctx.fillRect(o.x, o.y, 40, 40);
        }
    });

    ctx.fillStyle = "#000";
    ctx.fillText("Mode: " + gameMode, 10, 20);
}

/* ================= LOOP ================= */
function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
