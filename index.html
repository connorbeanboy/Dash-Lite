<script>
/* =========================================================
   DASH LITE â€” GEOMETRY DASH STYLE ENGINE
   Single-file foundation engine
   ========================================================= */

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// ================== AUDIO ==================
const sounds = {
    jump: new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"),
    death: new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"),
    portal: new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg")
};

// ================== GAME STATE ==================
let mode = "menu"; // menu | play | editor
let gameMode = "cube"; // cube ship ufo wave
let holding = false;
let scrollSpeed = 6;
let gravity = 0.7;

// ================== PLAYER ==================
const player = {
    x: 120,
    y: 300,
    size: 36,
    vy: 0,
    waveDir: -1
};

// ================== LEVEL DATA ==================
let levelObjects = [];
let editorSelection = "spike";

// ================== INPUT ==================
document.addEventListener("keydown", e => {
    if (e.code === "Space") holding = true;

    if (mode === "editor") {
        if (e.key === "1") editorSelection = "spike";
        if (e.key === "2") editorSelection = "block";
        if (e.key === "3") editorSelection = "cube";
        if (e.key === "4") editorSelection = "ship";
        if (e.key === "5") editorSelection = "ufo";
        if (e.key === "6") editorSelection = "wave";
        if (e.key === "s") saveLevel();
        if (e.key === "l") loadLevel();
        if (e.key === "p") startPlay();
    }

    if (e.key === "Escape") mode = "menu";
});

document.addEventListener("keyup", e => {
    if (e.code === "Space") holding = false;
});

canvas.addEventListener("mousedown", e => {
    if (mode !== "editor") return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    levelObjects.push({
        type: editorSelection,
        x: Math.floor(x / 40) * 40,
        y: Math.floor(y / 40) * 40
    });
});

// ================== SAVE / LOAD ==================
function saveLevel() {
    localStorage.setItem("dashLiteLevel", JSON.stringify(levelObjects));
}

function loadLevel() {
    const data = localStorage.getItem("dashLiteLevel");
    if (data) levelObjects = JSON.parse(data);
}

// ================== MODE SWITCH ==================
function setMode(m) {
    gameMode = m;
    sounds.portal.currentTime = 0;
    sounds.portal.play();
}

// ================== PLAY START ==================
function startPlay() {
    mode = "play";
    player.y = 300;
    player.vy = 0;
    gameMode = "cube";
}

// ================== COLLISION ==================
function hit(a, b, w = 40, h = 40) {
    return (
        a.x < b.x + w &&
        a.x + a.size > b.x &&
        a.y < b.y + h &&
        a.y + a.size > b.y
    );
}

// ================== UPDATE ==================
function update() {
    if (mode !== "play") return;

    // PHYSICS
    if (gameMode === "cube") {
        player.vy += gravity;
        if (holding && player.y >= 300) {
            player.vy = -13;
            sounds.jump.play();
        }
    }

    if (gameMode === "ship") {
        player.vy += holding ? -0.8 : 0.8;
        player.vy = Math.max(Math.min(player.vy, 7), -7);
    }

    if (gameMode === "ufo") {
        player.vy += gravity * 0.8;
        if (holding) {
            player.vy = -11;
            holding = false;
            sounds.jump.play();
        }
    }

    if (gameMode === "wave") {
        if (holding) player.waveDir = -1;
        else player.waveDir = 1;
        player.y += player.waveDir * 8;
    }

    player.y += player.vy;

    // FLOOR
    if (player.y + player.size > canvas.height) die();
    if (player.y < 0) die();

    // OBJECTS
    levelObjects.forEach(o => {
        o.x -= scrollSpeed;

        if (o.type === "spike" && hit(player, o)) die();
        if (o.type === "block" && hit(player, o)) die();

        if (["cube","ship","ufo","wave"].includes(o.type) && hit(player, o)) {
            setMode(o.type);
        }
    });
}

// ================== DIE ==================
function die() {
    sounds.death.play();
    startPlay();
}

// ================== DRAW ==================
function draw() {
    ctx.fillStyle = "#e6e6e6";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (mode === "menu") {
        ctx.fillStyle = "#000";
        ctx.font = "40px Arial";
        ctx.fillText("Dash Lite", 300, 180);
        ctx.font = "20px Arial";
        ctx.fillText("Press P to Play | E to Edit", 270, 220);
        return;
    }

    // PLAYER ICONS
    ctx.fillStyle =
        gameMode === "cube" ? "#ff5555" :
        gameMode === "ship" ? "#55ff55" :
        gameMode === "ufo" ? "#5555ff" :
        "#aa55ff";

    ctx.fillRect(player.x, player.y, player.size, player.size);

    // OBJECTS
    levelObjects.forEach(o => {
        if (o.type === "spike") {
            ctx.fillStyle = "#000";
            ctx.beginPath();
            ctx.moveTo(o.x, o.y + 40);
            ctx.lineTo(o.x + 20, o.y);
            ctx.lineTo(o.x + 40, o.y + 40);
            ctx.fill();
        } else if (o.type === "block") {
            ctx.fillStyle = "#333";
            ctx.fillRect(o.x, o.y, 40, 40);
        } else {
            ctx.fillStyle = "#00f";
            ctx.fillRect(o.x, o.y, 40, 40);
        }
    });

    // UI
    ctx.fillStyle = "#000";
    ctx.fillText(`MODE: ${gameMode.toUpperCase()}`, 10, 20);
}

// ================== LOOP ==================
function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
